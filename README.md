# WhatsApp AI Agent

A Python Flask server that turns WhatsApp into a powerful AI communication channel. It uses the Meta Cloud API for WhatsApp to receive messages via webhooks and respond with intelligence generated by OpenAI's Assistants API.

This isn't just a simple echo bot. It's a framework for building sophisticated, stateful AI agents that can remember conversations and use custom knowledge, all through WhatsApp.

## What It Does

*   **Listens:** Catches incoming WhatsApp messages in real-time using Meta's webhooks.
*   **Thinks:** Processes messages with a custom OpenAI Assistant, enabling complex reasoning and data retrieval.
*   **Remembers:** Maintains conversation context and history using OpenAI's thread management.
*   **Replies:** Sends intelligent, contextual responses back to the user on WhatsApp.

## Quick Start

### Prerequisites

1.  A Meta Developer Account and a configured WhatsApp Business App.
2.  An OpenAI API key with access to the Assistants API.
3.  Python 3.8+ and `pip`.

### Installation & Setup

1.  **Get the Code**
    ```bash
    git clone https://github.com/selenon/whatsapp-ai-agent.git
    cd whatsapp-ai-agent
    ```

2.  **Install Dependencies**
    ```bash
    pip install -r requirements.txt
    ```

3.  **Configure Environment**
    ```bash
    cp example.env .env
    ```
    Now edit the `.env` file and fill in your credentials:
    *   `APP_ID`: Your Meta App ID.
    *   `APP_SECRET`: Your Meta App Secret.
    *   `RECIPIENT_WAID`: Your WhatsApp number (used for initial setup).
    *   `ACCESS_TOKEN`: Your long-lived Meta System User access token.
    *   `OPENAI_API_KEY`: Your OpenAI API key.
    *   `OPENAI_ASSISTANT_ID`: The ID of your pre-configured OpenAI Assistant.
    *   `VERIFY_TOKEN`: A string of your choice for webhook verification.

### Running the Server

You need to expose your local server to the internet so Meta can send you webhooks.

1.  **Start the Flask app** (runs on port `8000` by default):
    ```bash
    python run.py
    ```

2.  **Expose it with ngrok.** (You need a static ngrok domain for Meta's validation).
    ```bash
    ngrok http 8000 --domain your-prepaid-domain.ngrok-free.app
    ```
    Ngrok will provide a public URL (e.g., `https://your-domain.ngrok-free.app`).

3.  **Configure the WhatsApp Webhook**
    *   Go to your [Meta App Dashboard](https://developers.facebook.com/) -> WhatsApp -> Configuration.
    *   Click **Edit** under Webhook.
    *   Set the **Callback URL** to your ngrok URL + `/webhook` (e.g., `https://your-domain.ngrok-free.app/webhook`).
    *   Set the **Verify Token** to the same string you put in your `.env` file.
    *   Click **Verify and Save**. Your running Flask app should handle the challenge request.
    *   Click **Manage**, subscribe to the `messages` field, and test the subscription.

### Testing

Send a message from your phone to your WhatsApp Business number. You should receive an intelligent reply from your OpenAI Assistant, not just an echo.

## How It Works / Code Overview

The core logic is split into focused modules:

*   `run.py`: The entry point. Starts the Flask server and defines the webhook endpoint.
*   `security.py`: Handles the critical task of verifying incoming webhook requests from Meta, ensuring they are genuine.
*   `whatsapp_utils.py`: Contains the main message flow logic (`process_whatsapp_message`). It extracts the user's message, gets a response from the AI, and formats the reply for WhatsApp.
*   `openai_service.py`: The brain. Manages the interaction with the OpenAI Assistants API, creating and running threads to get AI responses.

## Customizing the AI

The power of this bot comes from the OpenAI Assistant you connect it to.

1.  **Create an Assistant** in the [OpenAI Platform](https://platform.openai.com/assistants).
2.  **Configure it:** Give it instructions, enable the Code Interpreter or Retrieval tools, and upload files for it to use as knowledge.
3.  **Set the `OPENAI_ASSISTANT_ID`** in your `.env` file to your new Assistant's ID.

The `openai_service.py` file is where you'd customize how the assistant is called, for example, by passing specific parameters or handling different types of responses (like images from DALL-E).

## Going to Production

*   **Phone Number:** The initial setup uses a test number. For production, you must add and verify a dedicated phone number through the Meta platform. Migrating an existing personal number is possible but will disconnect it from the standard WhatsApp app.
*   **Server:** Replace the local Flask server and ngrok with a proper cloud server (e.g., AWS EC2, Google Cloud Run, Heroku).
*   **Token Management:** The `ACCESS_TOKEN` from a System User can be set to never expire, which is suitable for production. Ensure you store all secrets securely.

## License

MIT
